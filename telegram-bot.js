const TelegramBot = require('node-telegram-bot-api');
const fetch = require('node-fetch');

const token = '8522502658:AAGEDmPCiqsU8aZk5mCflXoE6HaJ06s4yoU';
const bot = new TelegramBot(token, { 
    polling: {
        interval: 300,
        params: {
            timeout: 10
        }
    }
});

const SERVER_URL = 'http://localhost:5000';

console.log('üöÄ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...');
console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É:', SERVER_URL);

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    
    bot.sendMessage(chatId, 
        `üîê –ë–æ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –°–£–î–£\n\n` +
        `–î–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–≤–µ–¥–∏—Ç–µ:\n` +
        `/link –ö–û–î_–ò–ó_–°–ê–ô–¢–ê\n\n` +
        `–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:\n` +
        `1. –ù–∞ —Å–∞–π—Ç–µ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?"\n` +
        `2. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à email\n` +
        `3. –ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–¥–µ—Ç —Å—é–¥–∞\n\n` +
        `–î–ª—è –ø–æ–º–æ—â–∏:\n` +
        `/help`
    );
});

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.onText(/\/help/, (msg) => {
    const chatId = msg.chat.id;
    
    bot.sendMessage(chatId,
        `üìñ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n\n` +
        `/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n` +
        `/link –ö–û–î - –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç (–∫–æ–¥ —Å —Å–∞–π—Ç–∞)\n` +
        `/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n` +
        `üí° –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:\n` +
        `1. –ù–∞ —Å–∞–π—Ç–µ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?"\n` +
        `2. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à email\n` +
        `3. –ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–¥–µ—Ç –≤ —ç—Ç–æ—Ç —á–∞—Ç\n` +
        `4. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –Ω–∞ —Å–∞–π—Ç–µ`
    );
});

// –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ –∫–æ–¥—É
bot.onText(/\/link (.+)/, async (msg, match) => {
    const chatId = msg.chat.id;
    const linkCode = match[1].trim();
    
    console.log(`üîó –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /link ${linkCode} –æ—Ç chatId: ${chatId}`);
    
    try {
        const response = await fetch(`${SERVER_URL}/api/auth/confirm-telegram-link`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                linkCode: linkCode,
                telegram_chat_id: chatId 
            })
        });
        
        console.log('üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
        
        const data = await response.json();
        console.log('üìä –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
        
        if (data.success) {
            bot.sendMessage(chatId, 
                `‚úÖ Telegram —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∞–∫–∫–∞—É–Ω—Ç—É:\n` +
                `üìß ${data.email}\n` +
                `üë§ ${data.name}\n\n` +
                `–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å! –î–ª—è —ç—Ç–æ–≥–æ:\n` +
                `1. –ù–∞ —Å–∞–π—Ç–µ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?"\n` +
                `2. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à email: ${data.email}\n` +
                `3. –ö–æ–¥ –ø—Ä–∏–¥–µ—Ç —Å—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏`
            );
        } else {
            bot.sendMessage(chatId, 
                `‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}\n\n` +
                `–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:\n` +
                `‚Ä¢ –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ —Å–∞–π—Ç–µ\n` +
                `‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏\n` +
                `‚Ä¢ –ö–æ–¥ –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω (–¥–µ–π—Å—Ç–≤—É–µ—Ç 10 –º–∏–Ω—É—Ç)`
            );
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏:', error);
        bot.sendMessage(chatId, 
            '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º\n\n' +
            '–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:\n' +
            '‚Ä¢ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:5000\n' +
            '‚Ä¢ –ë–æ—Ç –∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞ –æ–¥–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ\n' +
            '‚Ä¢ –°–æ–æ–±—â–∏—Ç–µ –æ–± –æ—à–∏–±–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É'
        );
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;
    
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if (!text.startsWith('/')) {
        bot.sendMessage(chatId,
            `ü§ñ –Ø –±–æ—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –°–£–î–£\n\n` +
            `–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:\n` +
            `/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n` +
            `/link –ö–û–î - –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç\n` +
            `/help - –ø–æ–º–æ—â—å\n\n` +
            `–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∞–π—Ç!`
        );
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.on('polling_error', (error) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ polling:', error);
});

bot.on('webhook_error', (error) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ webhook:', error);
});

console.log('ü§ñ Telegram Bot —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!');